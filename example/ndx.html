<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <title>Nasdaq 100 Index</title>

    <script type="text/javascript" src="../node_modules/jquery/tmp/jquery.js"></script>
    <script type="text/javascript" src="../node_modules/d3/d3.v2.js"></script>
    <script type="text/javascript" src="../node_modules/crossfilter/crossfilter.js"></script>

    <script type="text/javascript" src="../dc.js"></script>
    <script type="text/javascript" src="env-data.js"></script>

    <link rel="stylesheet" type="text/css" href="dc.css"/>
</head>
<body>

<h1>Nasdaq 100 Index 1985/11/01-2012/06/29</h1>

<div id="gain-loss-chart" class="chart">
    <span>Gain or Loss</span>
    <a class="reset" href="javascript:gainOrLossChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clear"></div>
</div>

<div id="fluctuation-chart" class="chart">
    <span>Fluctuation by Percentage</span>
    <a class="reset" href="javascript:fluctuationChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clear"></div>
</div>

<div class="clear"></div>

<div id="volume-month-chart" class="chart">
    <span>Trade Volume by Month</span>
    <a class="reset" href="javascript:volumeByMonthChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

    <div class="clear"></div>
</div>

<script type="text/javascript">
    var volumeByMonthChart = dc.barChart("#volume-month-chart");
    var gainOrLossChart = dc.pieChart("#gain-loss-chart");
    var fluctuationChart = dc.barChart("#fluctuation-chart");

    d3.csv("ndx.csv", function(data) {
                var totalDay = data.length;
                var dateFormat = d3.time.format("%m/%d/%Y");
                data.forEach(function(e) {
                    e.month = d3.time.month(dateFormat.parse(e.date));
                });

                var ndx = crossfilter(data);

                var volumeByMonth = ndx.dimension(function(d) {
                    return d.month;
                });
                var volumeByMonthGroup = volumeByMonth.group().reduceSum(function(d) {
                    return d.volume;
                });

                var gainOrLoss = ndx.dimension(function(d) {
                    return d.open > d.close ? "Loss" : "Gain";
                });
                var gainOrLossGroup = gainOrLoss.group();

                var fluctuation = ndx.dimension(function(d){
                    return Math.floor((d.high - d.low) / d.open * 100);
                });
                var fluctuationGroup = fluctuation.group();

                volumeByMonthChart.width(1100)
                        .height(250)
                        .margins({top: 10, right: 50, bottom: 30, left: 40})
                        .dimension(volumeByMonth)
                        .group(volumeByMonthGroup)
                        .x(d3.time.scale().domain([new Date(1985, 0, 1), new Date(2012, 11, 31)]))
                        .xUnits(d3.time.months);

                gainOrLossChart.width(250)
                        .height(250)
                        .radius(100)
                        .dimension(gainOrLoss)
                        .group(gainOrLossGroup)
                        .label(function(d){
                            return d.data.key + "("+ Math.floor(d.data.value/totalDay*100) +"%)";
                        });

                fluctuationChart.width(400)
                        .height(200)
                        .dimension(fluctuation)
                        .group(fluctuationGroup)
                        .x(d3.scale.ordinal().domain([0, 10]));

                dc.renderAll();
            }
    );
</script>

<div class="clear"></div>

<div>
    <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
</div>

</body>
</html>