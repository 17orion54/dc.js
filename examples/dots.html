<!DOCTYPE html>
<html lang="en">
<head>
    <title>dc.js - Line Chart Example</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="../css/dc.css"/>
</head>
<body>

<div id="articleTypeChart"></div>

<script type="text/javascript" src="../js/d3.js"></script>
<script type="text/javascript" src="../js/crossfilter.js"></script>
<script type="text/javascript" src="../js/dc.js"></script>
<script type="text/javascript">

var data = [{
    "validationDate": 1351244266074,
        "cutter": "cutter cutter",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "COOL-LITE SKN154 6",
        "cutterNetSqm": 10.430196,
        "cutterOptiSqm": 44.21052631578947,
        "cutterGrossSqm": 44.94,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1357546197919,
        "cutter": "cutter cutter",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "COOL-LITE SKN154 6",
        "cutterNetSqm": 13.410252,
        "cutterOptiSqm": 56.8421052631579,
        "cutterGrossSqm": 57.78,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1357665269814,
        "cutter": "system system",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "COOL-LITE SKN154 6",
        "cutterNetSqm": 4.470084,
        "cutterOptiSqm": 18.94736842105263,
        "cutterGrossSqm": 19.26,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1373532600000,
        "cutter": "system system",
        "cuttingMachine": "B1 (Bot 501A)",
        "articleType": "44.2",
        "cutterNetSqm": 1.3348967606855355,
        "cutterOptiSqm": 5.712458619889327,
        "cutterGrossSqm": 77.2,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1351261225831,
        "cutter": "cutter cutter",
        "cuttingMachine": "B1 (Bot 501A)",
        "articleType": "44.2",
        "cutterNetSqm": 0.22202168921246473,
        "cutterOptiSqm": 0.9501032212354787,
        "cutterGrossSqm": 12.84,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1351262476835,
        "cutter": "cutter cutter",
        "cuttingMachine": "B1 (Bot 501A)",
        "articleType": "44.2",
        "cutterNetSqm": 0.11101084460623237,
        "cutterOptiSqm": 0.4750516106177394,
        "cutterGrossSqm": 6.42,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1351532719787,
        "cutter": "system system",
        "cuttingMachine": "B1 (Bot 501A)",
        "articleType": "44.2",
        "cutterNetSqm": 26.64260270549577,
        "cutterOptiSqm": 114.01238654825745,
        "cutterGrossSqm": 1540.8,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1356000576889,
        "cutter": "system system",
        "cuttingMachine": "D3 (Bys 92)",
        "articleType": "G4",
        "cutterNetSqm": 51.54777952941176,
        "cutterOptiSqm": 54.588235294117645,
        "cutterGrossSqm": 77.04,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1356000738779,
        "cutter": "system system",
        "cuttingMachine": "D3 (Bys 92)",
        "articleType": "G4",
        "cutterNetSqm": 64.4347244117647,
        "cutterOptiSqm": 68.23529411764706,
        "cutterGrossSqm": 96.3,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1357727946565,
        "cutter": "cutter cutter",
        "cuttingMachine": "D3 (Bys 92)",
        "articleType": "G4",
        "cutterNetSqm": 51.54777952941176,
        "cutterOptiSqm": 54.588235294117645,
        "cutterGrossSqm": 77.04,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1357727946580,
        "cutter": "cutter cutter",
        "cuttingMachine": "D3 (Bys 92)",
        "articleType": "G4",
        "cutterNetSqm": 51.54777952941176,
        "cutterOptiSqm": 54.588235294117645,
        "cutterGrossSqm": 77.04,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1357722152035,
        "cutter": "system system",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "PFUN 4",
        "cutterNetSqm": 48.7408136,
        "cutterOptiSqm": 52.2,
        "cutterGrossSqm": 38.52,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1358849921958,
        "cutter": "system system",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "PFUN 4",
        "cutterNetSqm": 97.4816272,
        "cutterOptiSqm": 104.4,
        "cutterGrossSqm": 77.04,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1359369226205,
        "cutter": "cutter cutter",
        "cuttingMachine": "D1 (Bys 97)",
        "articleType": "PFUN 4",
        "cutterNetSqm": 97.4816272,
        "cutterOptiSqm": 104.4,
        "cutterGrossSqm": 77.04,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1364483327864,
        "cutter": "cutter cutter",
        "cuttingMachine": "Decoupe float",
        "articleType": "G4",
        "cutterNetSqm": 200.079685,
        "cutterOptiSqm": 211,
        "cutterGrossSqm": 57.78,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1359379973365,
        "cutter": "system system",
        "cuttingMachine": "Decoupe float",
        "articleType": "BIO4",
        "cutterNetSqm": 3.12352,
        "cutterOptiSqm": 18.08,
        "cutterGrossSqm": 19.26,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}, {
    "validationDate": 1358255708159,
        "cutter": "cutter cutter",
        "cuttingMachine": "Decoupe float",
        "articleType": "PFUN 4",
        "cutterNetSqm": 37.871241,
        "cutterOptiSqm": 56,
        "cutterGrossSqm": 57.78,
        "cutterBrokenSheetsSqm": 0,
        "cutterRemakesSqm": null
}];
var articleTypeChart = dc.lineChart("#articleTypeChart"),
    articleTypes = [];
var ndx = crossfilter(data),
    articleTypeDimension = ndx.dimension(function (d) {
        return d.articleType;
    }),
    articleTypeGroup = articleTypeDimension.group().reduce(normalReduceAdd, normalReduceRemove, normalReduceInitial);
var margin = {
    top: 10,
    right: 20,
    bottom: 60,
    left: 40
}, barConfig = {
    width: 600 - margin.left - margin.right,
    height: 300 - margin.top - margin.bottom
};

articleTypeChart.width(barConfig.width)
    .height(barConfig.height)
    .margins(margin)
    .x(d3.scale.ordinal())
    .xUnits(dc.units.ordinal)
    .renderHorizontalGridLines(true)
    .legend(dc.legend().x(400).y(0).itemHeight(10))
    .dimension(articleTypeDimension)
    .group(articleTypeGroup, "ratio")
    .valueAccessor(function (p) {
      var ratio = (1 - p.value.cutterNetSqm / (p.value.cutterGrossSqm + p.value.cutterBrokenSheetsSqm)) * 100;
      return Math.abs(ratio) == Infinity ? 0 : ratio;
    })
    .colors('red')
    //.renderDataPoints(true)
    .y(d3.scale.linear().domain([-100, 120]))
    .yAxis()
      .tickFormat(function (v) {
          return v + "%";
      });
console.log(articleTypeChart.data());
//articleTypeChart.renderlet(rotateLabel);

dc.renderAll();

function rotateLabel(chart) {
    chart.selectAll("g.x text")
        .style("text-anchor", "end")
        .attr("dx", "-.8em")
        .attr("dy", ".15em")
        .attr('transform', "rotate(-45)");
}

function normalReduceAdd(p, v) {
    /* callback for when data is added to the current filter results */++p.count;
    p.cutterNetSqm += v.cutterNetSqm;
    p.cutterGrossSqm += v.cutterGrossSqm;
    p.cutterBrokenSheetsSqm += v.cutterBrokenSheetsSqm;
    return p;
}

function normalReduceRemove(p, v) {
    /* callback for when data is removed from the current filter results */--p.count;
    p.cutterNetSqm -= v.cutterNetSqm;
    p.cutterGrossSqm -= v.cutterGrossSqm;
    p.cutterBrokenSheetsSqm -= v.cutterBrokenSheetsSqm;
    return p;
}

function normalReduceInitial() {
    /* initialize p */
    return {
        count: 0,
        cutterNetSqm: 0,
        cutterGrossSqm: 0,
        cutterBrokenSheetsSqm: 0
    };
}

</script>

</body>
</html>
